# Telegram Bot на Python

Основа для Telegram-бота с использованием python-telegram-bot (версии 20+) и asyncio.

## Структура проекта

```
.
├── main.py           # Точка входа, запуск бота
├── config.py         # Загрузка переменных окружения
├── handlers.py       # Обработчики сообщений и команд
├── db.py            # Модуль для работы с PostgreSQL (заготовка)
├── requirements.txt  # Зависимости проекта
├── .env.example     # Пример файла с переменными окружения
└── README.md        # Этот файл
```

## Установка и настройка

1. **Установите зависимости:**
   ```bash
   pip install -r requirements.txt
   ```

2. **Создайте файл `.env`:**
   ```bash
   cp .env.example .env
   ```

3. **Заполните переменные окружения в файле `.env`:**
   ```
   TELEGRAM_BOT_TOKEN=your_bot_token_here
   ADMIN_TELEGRAM_ID=your_admin_id_here
   ```

   Где:
   - `TELEGRAM_BOT_TOKEN` - токен вашего бота от @BotFather
   - `ADMIN_TELEGRAM_ID` - ваш Telegram ID для получения уведомлений об ошибках
   - `DB_HOST` - хост PostgreSQL (по умолчанию localhost)
   - `DB_PORT` - порт PostgreSQL (по умолчанию 5432)
   - `DB_USER` - пользователь базы данных
   - `DB_PASSWORD` - пароль базы данных
   - `DB_NAME` - имя базы данных

## Запуск

```bash
python main.py
```

Для остановки бота используйте `Ctrl+C`.

## Функциональность

### Реализованные команды:
- `/start` - приветствие и информация о боте

### Реализованные обработчики:
- **Система верификации новых участников** с ограничением прав и кнопкой подтверждения
- Автоматическое удаление пользователей при неподтверждении в течение 2 минут
- Приветствие новых участников в групповых чатах (резервный метод)
- Обработка инлайн-кнопок для верификации
- Обработка неизвестных команд
- Обработка ошибок с уведомлением администратора

### Возможности:
- Асинхронный запуск и остановка
- Логирование в файл и консоль
- Graceful shutdown при получении сигналов SIGINT/SIGTERM
- Автоматическое уведомление администратора об ошибках

## Разработка

### Добавление новых команд:
1. Создайте обработчик в `handlers.py`
2. Зарегистрируйте его в `main.py` в методе `setup_application()`

### Добавление новых переменных окружения:
1. Добавьте переменную в `config.py`
2. Обновите `.env.example`

## Логи

Логи сохраняются в файл `bot.log` и выводятся в консоль.

## База данных

### Структура таблиц:

**users:**
- `user_id` (BIGINT, PRIMARY KEY) - Telegram ID пользователя
- `username` (TEXT) - имя пользователя в Telegram
- `first_name` (TEXT) - имя пользователя
- `join_date` (TIMESTAMP WITH TIME ZONE) - дата присоединения
- `is_approved` (BOOLEAN) - статус одобрения
- `spam_reports` (INTEGER) - количество жалоб на спам

**messages:**
- `message_id` (SERIAL, PRIMARY KEY) - ID сообщения
- `user_id` (BIGINT, REFERENCES users) - ID пользователя
- `message_text` (TEXT) - текст сообщения
- `is_spam` (BOOLEAN) - отмечено ли как спам
- `timestamp` (TIMESTAMP WITH TIME ZONE) - время сообщения

### Реализованные функции базы данных:
- `get_pool()` - создание пула соединений
- `init_db()` - инициализация таблиц
- `add_new_user()` - добавление нового пользователя
- `get_user()` - получение информации о пользователе
- `approve_user()` - одобрение пользователя
- `log_message()` - логирование сообщений
- `increment_spam_reports()` - увеличение счетчика спама
- `get_user_stats()` - статистика пользователей

## Тестирование

Запуск тестов:
```bash
pytest test_db.py -v
```

Тесты используют моки для имитации работы с базой данных и проверяют:
- Корректность работы функций
- Обработку ошибок
- Интеграционные сценарии

## Следующие шаги

- Добавление команд администратора
- Интеграция с LLM для анализа спама
- Расширение функций модерации
- Добавление системы уведомлений
